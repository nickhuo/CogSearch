<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Letter Comparison Round {{ round_number }} - All Items</title>
  <base target="_top">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/letter_style.css') }}">
  <style>
    body {
      font-family: "Times New Roman", "Times New Roman Regular", Times, serif;
      font-size: 16pt;
    }
    td { font-size: 16pt; }
    .question-text { font-size: 14pt; text-align: center; }
  </style>
</head>
<body>
  <div class="lc-container">
    <div class="lc-header">
      <h1>Letter Comparison Round {{ round_number }}</h1>
      <p>
        Please do as fast as you can.
        </p>
    </div>
    
    <form method="post" action="{{ action_url }}" id="letterCompForm">
      <div class="items-container">
        {% for item in items %}
        <div class="item">
          <div class="item-number">{{ loop.index }}</div>
          <div class="strings">{{ item.left }}</div>
          <div class="choice-container">
            <label class="choice-option">
              <input type="radio" name="choice_{{ loop.index }}" value="S" id="s_{{ loop.index }}" data-index="{{ loop.index }}" required />
              <span>S</span>
            </label>
            <label class="choice-option">
              <input type="radio" name="choice_{{ loop.index }}" value="D" id="d_{{ loop.index }}" data-index="{{ loop.index }}" />
              <span>D</span>
            </label>
          </div>
          <div class="strings">{{ item.right }}</div>
        </div>
        {% endfor %}
      </div>

      <div class="actions">
        <button type="submit" class="submit-btn">
          <img src="{{ url_for('static', filename='images/done_button.gif') }}" alt="Done" />
        </button>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById('letterCompForm');
    const actionUrl = form.getAttribute('action');
    const totalItems = parseInt('{{ total_items }}', 10);
    const savedItems = new Set();
    const pendingItems = new Set();

    function saveChoice(itemIndex, choiceValue) {
      const data = new FormData();
      data.append('item_index', itemIndex);
      data.append('choice', choiceValue);
      data.append('save_only', '1');

      pendingItems.add(Number(itemIndex));

      return fetch(actionUrl, {
        method: 'POST',
        body: data,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      }).then((response) => {
        if (!response.ok) {
          throw new Error('Bad response status: ' + response.status);
        }
        savedItems.add(Number(itemIndex));
        pendingItems.delete(Number(itemIndex));
      });
    }

    document.querySelectorAll('.choice-option input[type="radio"]').forEach((input) => {
      input.addEventListener('change', () => {
        const itemIndex = input.dataset.index;
        saveChoice(itemIndex, input.value).catch((err) => {
          console.error('Failed to save letter comparison response', err);
          savedItems.delete(Number(itemIndex));
          pendingItems.delete(Number(itemIndex));
          window.alert('Network issue: answer not saved. Please try selecting again.');
        });
      });
    });

    // 记录页面加载时间
    const pageLoadTime = Date.now();
    
    // 添加表单验证和提交处理
    form.addEventListener('submit', function(e) {
      let allAnswered = true;
      
      for (let i = 1; i <= totalItems; i++) {
        const choice = document.querySelector(`input[name="choice_${i}"]:checked`);
        if (!choice) {
          allAnswered = false;
          break;
        }
      }
      
      if (!allAnswered) {
        e.preventDefault();
        alert('Please complete all items before submitting!');
        return false;
      }

      if (pendingItems.size > 0) {
        e.preventDefault();
        alert('Please wait for answers to finish saving before submitting.');
        return false;
      }

      if (savedItems.size !== totalItems) {
        e.preventDefault();
        alert('Please make sure each answer is saved before submitting.');
        return false;
      }
      
      // 计算总时间（从页面加载到点击done）
      const totalTime = Date.now() - pageLoadTime;
      
      // 添加隐藏字段传递总时间
      const timeInput = document.createElement('input');
      timeInput.type = 'hidden';
      timeInput.name = 'total_time_ms';
      timeInput.value = totalTime;
      this.appendChild(timeInput);

      const skipInput = document.createElement('input');
      skipInput.type = 'hidden';
      skipInput.name = 'skip_save';
      skipInput.value = '1';
      this.appendChild(skipInput);
      
    });

    // 添加键盘快捷键支持
    document.addEventListener('keydown', function(e) {
      // 按Enter键提交表单
      if (e.key === 'Enter' && e.ctrlKey) {
        document.getElementById('letterCompForm').submit();
      }
    });
  </script>
</body>
</html>
