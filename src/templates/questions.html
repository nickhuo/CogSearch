<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Comprehension Questions</title>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/questions_style.css') }}">
  </head>
  
  <body>
  <div class="container">
      <h2>Comprehension Questions</h2>
      <div class="cl2">
        <p>
          The multiple-choice questions here are based on the passages you read in the formal task. Please do your best to answer each question carefully. If you are not sure, please select “I don't know the answer”. 
        </p>
        <br>
      </div>
  
      {% if not questions_by_passage %}
        <p>No comprehension questions are available at this time.</p>
      {% else %}
      <form method="POST" action="{{ url_for('core.done') }}">
          {% set counter = namespace(value=1) %}
          <div class="row" id="questionsGrid">
          {% for block in questions_by_passage %}
            {% for q in block.questions %}
            <div class="col-md-6 question-item" data-index="{{ counter.value - 1 }}">
              <div class="card mb-4">
                <div class="card-header">Question {{ counter.value }}</div>
                <div class="card-body">
                    <p class="card-text">{{ q.questionText }}</p>
  
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" 
                             name="q_{{ q.questionID }}" value="a" required
                             {% if existing_answers.get(q.questionID) == 'a' %}checked{% endif %}>
                      {{ q.choiceA }}
                    </label>
  
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" 
                             name="q_{{ q.questionID }}" value="b"
                             {% if existing_answers.get(q.questionID) == 'b' %}checked{% endif %}>
                      {{ q.choiceB }}
                    </label>
  
                    {% if q.choiceC %}
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" 
                             name="q_{{ q.questionID }}" value="c"
                             {% if existing_answers.get(q.questionID) == 'c' %}checked{% endif %}>
                      {{ q.choiceC }}
                    </label>
                    {% endif %}
  
                    {% if q.choiceD %}
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" 
                             name="q_{{ q.questionID }}" value="d"
                             {% if existing_answers.get(q.questionID) == 'd' %}checked{% endif %}>
                      {{ q.choiceD }}
                    </label>
                    {% endif %}
                    
                    {% if q.choiceE %}
                    <label class="form-check-label">
                      <input class="form-check-input" type="radio" 
                             name="q_{{ q.questionID }}" value="E"
                             {% if existing_answers.get(q.questionID) == 'E' %}checked{% endif %}>
                      {{ q.choiceE }}
                    </label>
                    {% endif %}

                </div>
              </div>
            </div>
            {% set counter.value = counter.value + 1 %}
            {% endfor %}
          {% endfor %}
          </div>
        <nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Question pagination">
          <button type="button" class="image-btn" id="prevPage" aria-label="Back">
            <img src="{{ url_for('static', filename='images/back_button.gif') }}" alt="Back">
          </button>
          <span id="pageIndicator" class="mx-3"></span>
          <button type="button" class="image-btn" id="nextPage" aria-label="Next">
            <img src="{{ url_for('static', filename='images/nextpage_button.gif') }}" alt="Next">
          </button>
        </nav>

        <div class="mt-4 d-flex justify-content-center">
            <button type="submit" class="image-btn" aria-label="Done">
                <img src="{{ url_for('static', filename='images/done_button.gif') }}" alt="Done">
            </button>
        </div>
    </form>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var ITEMS_PER_PAGE = 10;
  var grid = document.getElementById('questionsGrid');
  if (!grid) { return; }
  var items = Array.prototype.slice.call(grid.querySelectorAll('.question-item'));
  var totalItems = items.length;
  var totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
  var currentPage = 1;

  var prevBtn = document.getElementById('prevPage');
  var nextBtn = document.getElementById('nextPage');
  var indicator = document.getElementById('pageIndicator');

  function renderPage(page) {
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    currentPage = page;
    var start = (currentPage - 1) * ITEMS_PER_PAGE;
    var end = start + ITEMS_PER_PAGE;

    for (var i = 0; i < totalItems; i++) {
      var item = items[i];
      if (i >= start && i < end) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    }

    // Equalize visible card min-heights on current page (elastic growth permitted)
    var visibleCards = [];
    var maxHeight = 0;
    for (var j = start; j < Math.min(end, totalItems); j++) {
      var itemEl = items[j];
      if (!itemEl || itemEl.style.display === 'none') continue;
      var cardEl = itemEl.querySelector('.card');
      if (!cardEl) continue;
      cardEl.style.minHeight = '0px';
      var h = cardEl.offsetHeight;
      if (h > maxHeight) maxHeight = h;
      visibleCards.push(cardEl);
    }
    for (var k = 0; k < visibleCards.length; k++) {
      visibleCards[k].style.minHeight = maxHeight + 'px';
    }

    if (prevBtn) {
      if (currentPage === 1) {
        prevBtn.style.visibility = 'hidden';
        prevBtn.disabled = true;
      } else {
        prevBtn.style.visibility = 'visible';
        prevBtn.disabled = false;
      }
    }
    if (nextBtn) {
      if (currentPage === totalPages) {
        nextBtn.style.visibility = 'hidden';
        nextBtn.disabled = true;
      } else {
        nextBtn.style.visibility = 'visible';
        nextBtn.disabled = false;
      }
    }
    if (indicator) {
      indicator.textContent = 'Page ' + currentPage + ' of ' + totalPages;
    }
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', function() { renderPage(currentPage - 1); });
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function() { renderPage(currentPage + 1); });
  }

  // Disable native validation to allow custom cross-page validation
  var form = document.querySelector('form');
  if (form) {
    form.setAttribute('novalidate', 'novalidate');
    form.addEventListener('submit', function(e) {
      var firstUnansweredIndex = -1;
      for (var i = 0; i < totalItems; i++) {
        var item = items[i];
        var radios = item.querySelectorAll('input[type="radio"]');
        var answered = false;
        for (var r = 0; r < radios.length; r++) {
          if (radios[r].checked) { answered = true; break; }
        }
        if (!answered) { firstUnansweredIndex = i; break; }
      }
      if (firstUnansweredIndex !== -1) {
        e.preventDefault();
        var targetPage = Math.floor(firstUnansweredIndex / ITEMS_PER_PAGE) + 1;
        renderPage(targetPage);
        // Highlight and scroll to the first unanswered item
        var target = items[firstUnansweredIndex];
        if (target) {
          target.classList.add('border', 'border-danger');
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setTimeout(function() { target.classList.remove('border', 'border-danger'); }, 2000);
        }
        alert('Please complete all questions. Navigated to the first unanswered question.');
        return false;
      }
      return true;
    });
  }

  renderPage(1);
  // Re-equalize on window resize
  window.addEventListener('resize', function() { renderPage(currentPage); });
});
</script>
</body>
</html>
